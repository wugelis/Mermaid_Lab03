# ?? 快速開始：從紅燈到綠燈

## ?? 您目前的位置

? **紅燈階段已完成**
- 測試案例已建立
- 骨架程式碼已完成
- 建置成功
- 測試預期失敗（這是正確的！）

## ?? 下一步：實作驗證邏輯（綠燈階段）

### Step 1: 安裝 BCrypt 套件

在 Visual Studio 的 **套件管理器主控台** 執行：

```powershell
Install-Package BCrypt.Net-Next -Version 4.0.3 -ProjectName Domain.RentalCarLab1
```

或使用 NuGet 套件管理員：
1. 右鍵點選 `Domain.RentalCarLab1` 專案
2. 管理 NuGet 套件
3. 搜尋 "BCrypt.Net-Next"
4. 安裝版本 4.0.3

---

### Step 2: 修改 Password.cs

開啟 `Domain.RentalCarLab1\ValueObjects\Password.cs`，將 `Create` 方法改為：

```csharp
public static Password Create(string plainPassword)
{
    // 1. 檢查 null 或空字串
    if (string.IsNullOrWhiteSpace(plainPassword))
        throw new ArgumentException("密碼不能為空", nameof(plainPassword));

    // 2. 檢查長度 (至少 8 字元)
    if (plainPassword.Length < 8)
        throw new ArgumentException("密碼至少需要 8 個字元", nameof(plainPassword));

    // 3. 檢查是否包含大寫字母
    if (!plainPassword.Any(char.IsUpper))
        throw new ArgumentException("密碼至少包含一個大寫字母", nameof(plainPassword));

    // 4. 檢查是否包含小寫字母
    if (!plainPassword.Any(char.IsLower))
        throw new ArgumentException("密碼至少包含一個小寫字母", nameof(plainPassword));

    // 5. 檢查是否包含數字
    if (!plainPassword.Any(char.IsDigit))
        throw new ArgumentException("密碼至少包含一個數字", nameof(plainPassword));

    // 6. 檢查是否包含特殊字元
    const string specialChars = "!@#$%^&*()_+-=[]{}|;:,.<>?";
    if (!plainPassword.Any(c => specialChars.Contains(c)))
        throw new ArgumentException("密碼至少包含一個特殊字元", nameof(plainPassword));

    // 7. 使用 BCrypt 進行雜湊
    string hashedPassword = BCrypt.Net.BCrypt.HashPassword(plainPassword);
    
    return new Password(hashedPassword);
}
```

**記得加入 using:**
```csharp
using System.Linq;
```

---

### Step 3: 實作 Verify 方法

在同一個檔案中，將 `Verify` 方法改為：

```csharp
public bool Verify(string plainPassword)
{
    if (string.IsNullOrWhiteSpace(plainPassword))
        return false;

    return BCrypt.Net.BCrypt.Verify(plainPassword, HashedValue);
}
```

---

### Step 4: 執行測試

#### 方法 1: Visual Studio Test Explorer
1. 按 `Ctrl + E, T` 開啟測試總管
2. 點選 "執行所有測試"
3. ? 應該看到所有測試變成綠色！

#### 方法 2: 命令列
```powershell
cd Domain.RentalCar.Tests
dotnet test
```

---

### Step 5: 驗證結果

預期看到：
```
測試執行摘要
  總計: 6
  通過: 6 ?
  失敗: 0

? TC-D10: Should_ThrowArgumentException_WhenPasswordHasNoUpperCase
? TC-D11: Should_ThrowArgumentException_WhenPasswordHasNoLowerCase
? TC-D12: Should_ThrowArgumentException_WhenPasswordHasNoDigit
? TC-D13: Should_ThrowArgumentException_WhenPasswordHasNoSpecialChar
? TC-D14: Should_HashPasswordUsingBCrypt_WhenCreated
```

---

## ?? 完整的 Password.cs 範例

<details>
<summary>點擊查看完整程式碼</summary>

```csharp
using System;
using System.Linq;

namespace Domain.RentalCarLab1.ValueObjects
{
    /// <summary>
    /// Password Value Object - 已實作驗證和雜湊
    /// </summary>
    public class Password
    {
        /// <summary>
        /// 密碼的雜湊值
        /// </summary>
        public string HashedValue { get; private set; }

        /// <summary>
        /// 私有建構子 - 強制使用 Create 工廠方法
        /// </summary>
        private Password(string hashedValue)
        {
            HashedValue = hashedValue;
        }

        /// <summary>
        /// 建立 Password 物件的工廠方法
        /// </summary>
        public static Password Create(string plainPassword)
        {
            // 1. 檢查 null 或空字串
            if (string.IsNullOrWhiteSpace(plainPassword))
                throw new ArgumentException("密碼不能為空", nameof(plainPassword));

            // 2. 檢查長度
            if (plainPassword.Length < 8)
                throw new ArgumentException("密碼至少需要 8 個字元", nameof(plainPassword));

            // 3. 檢查大寫字母
            if (!plainPassword.Any(char.IsUpper))
                throw new ArgumentException("密碼至少包含一個大寫字母", nameof(plainPassword));

            // 4. 檢查小寫字母
            if (!plainPassword.Any(char.IsLower))
                throw new ArgumentException("密碼至少包含一個小寫字母", nameof(plainPassword));

            // 5. 檢查數字
            if (!plainPassword.Any(char.IsDigit))
                throw new ArgumentException("密碼至少包含一個數字", nameof(plainPassword));

            // 6. 檢查特殊字元
            const string specialChars = "!@#$%^&*()_+-=[]{}|;:,.<>?";
            if (!plainPassword.Any(c => specialChars.Contains(c)))
                throw new ArgumentException("密碼至少包含一個特殊字元", nameof(plainPassword));

            // 7. BCrypt 雜湊
            string hashedPassword = BCrypt.Net.BCrypt.HashPassword(plainPassword);
            
            return new Password(hashedPassword);
        }

        /// <summary>
        /// 驗證明文密碼
        /// </summary>
        public bool Verify(string plainPassword)
        {
            if (string.IsNullOrWhiteSpace(plainPassword))
                return false;

            return BCrypt.Net.BCrypt.Verify(plainPassword, HashedValue);
        }

        #region Value Object Pattern

        public override bool Equals(object obj)
        {
            if (obj == null || GetType() != obj.GetType())
                return false;

            var other = (Password)obj;
            return HashedValue == other.HashedValue;
        }

        public override int GetHashCode()
        {
            return HashedValue?.GetHashCode() ?? 0;
        }

        public static bool operator ==(Password left, Password right)
        {
            if (ReferenceEquals(left, null))
                return ReferenceEquals(right, null);
            return left.Equals(right);
        }

        public static bool operator !=(Password left, Password right)
        {
            return !(left == right);
        }

        #endregion
    }
}
```

</details>

---

## ?? 常見問題

### Q1: BCrypt 安裝失敗
**解決方案:**
```powershell
# 嘗試使用較舊版本
Install-Package BCrypt.Net-Next -Version 4.0.2
```

### Q2: 找不到 System.Linq
**解決方案:**
在 Password.cs 檔案最上方加入:
```csharp
using System.Linq;
```

### Q3: 測試仍然失敗
**檢查清單:**
- [ ] BCrypt 套件已安裝
- [ ] using System.Linq; 已加入
- [ ] Password.Create() 已正確實作所有驗證
- [ ] 重新建置解決方案 (Ctrl + Shift + B)

---

## ?? TDD 進度追蹤

```
[?] ?? 紅燈階段 - 骨架程式碼完成
[?] ?? 綠燈階段 - 實作驗證邏輯 ← 您在這裡
[  ] ?? 重構階段 - 優化程式碼
```

---

## ?? 恭喜！

完成綠燈階段後，您將擁有：
- ? 完整的 Password Value Object
- ? 100% 測試覆蓋率
- ? 安全的密碼雜湊機制
- ? 符合 DDD 設計原則

---

**需要協助？** 查看 `TDD_紅燈階段_完成總結.md` 獲得更多詳細資訊。
